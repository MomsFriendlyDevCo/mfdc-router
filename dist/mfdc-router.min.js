"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_=require("lodash"),$q=require("q");module.exports=function(){var router=this;router.routes=[],router.path=null,router.params={},router.query={},router.current=null,router.priorityAliases={first:100,highest:100,normal:50,default:50,low:25,lowest:0,last:0},router.nextRuleId=0,router.sort={enabled:!0,isSorted:!1,keyOrder:[{key:"_priority",reverse:!0},{key:"_pathHuman",charOrder:"abcdefghijklmnopqrstuvwxyz0123456789:/-_",fallback:function(){return String.fromCharCode(65e3)}},{key:"_path",charOrder:"abcdefghijklmnopqrstuvwxyz0123456789:/-_",fallback:function(){return String.fromCharCode(65e3)}}],sorter:function(){router.sort.keyOrder.forEach(function(keyRule){keyRule.charOrder&&(keyRule.charOrderTable={},keyRule.charOrder.split("").forEach(function(c,i){return keyRule.charOrderTable[c]=String.fromCharCode(i+65)}))}),router.routes=router.routes.map(function(r){return[r].concat(router.sort.keyOrder.map(function(keyRule){return _.hasIn(r,keyRule.key)?keyRule.charOrderTable?r[keyRule.key].toString().split("").map(function(c){return keyRule.charOrderTable[c]||keyRule.fallback(c)}).join(""):r[keyRule.key]:void 0}))}).sort(function(a,b){for(var k=0;k<router.sort.keyOrder.length;k++)if(!_.isUndefined(a[k+1])&&!_.isUndefined(b[k+1])&&a[k+1]!=b[k+1])return a[k+1]>b[k+1]?router.sort.keyOrder[k].reverse?-1:1:router.sort.keyOrder[k].reverse?1:-1}).map(function(i){return i[0]})}},router.warns={requiresChecking:!0},router.tokenRules={},router.redirect=function(url){throw new Error("router.redirect() needs overriding with whatever redirection scheme you are using")},router.setHash=function(hash){throw new Error("router.setHash() needs overriding with whatever redirection scheme you are using")};var RouterRule=function(path){var _this=this;return this._id="route-"+router.nextRuleId++,this._path,this._action="views",this._component={main:null},this._redirect,this._segments=[],this._priority=50,this._requires=[],this._data={},this._params={},this.views={},this.id=function(newId){return this._id=newId,this},this.component=function(id,component){return this._action="views",this.view(_.isObject(id)?id:"main","component",_.isString(id)?id:void 0)},this.template=function(id,template){return this._action="views",this.view(_.isObject(id)?id:"main","template",_.isString(id)?id:void 0)},this.templateUrl=function(id,url){return this._action="views",this.view(_.isObject(id)?id:"main","templateUrl",_.isString(id)?id:void 0)},this.templateURL=this.templateUrl,this.view=function(id,method,content){if(this._action="views",_.isObject(id))this.views=_.mapValues(id,function(v,k){return{content:v}}),method&&_.forEach(this.views,function(v,k){return v.method=method});else if(_.isString(id)&&_.isObject(method))this.views[id]=method;else{if(!(_.isString(id)&&_.isString(method)&&_.isString(content)))throw new Error("Unknown call pattern. See docs for RouterRule.view() for permitted patterns");this.views[id]={method:method,content:content}}return this},this.go=function(path){return this._action="redirect",this._redirect=path,this},this.redirect=this.go,this.priority=function(priority){if(isFinite(priority))this._priority=priority;else{if(!router.priorityAliases.hasOwnProperty(priority))throw new Error("Unknown priority number or alias: "+priority);this._priority=router.priorityAliases[priority]}return this},this.data=function(key,value){return void 0===value?this._data=data:this._data[key]=value,this},this.params=function(key,value){return void 0===value?this._params=data:this._params[key]=value,this},this.title=function(title){return _this.data("title",title)},this.requires=function(){return router.warns.requiresChecking&&_.flatten(arguments).forEach(function(p){_.isFunction(p)||console.warn("RouterRule.requires() must be passed a PROMISE FACTORY - "+(_.hasIn(p,"then")?"promises only ever run once!":"was given unexpected type: "+(void 0===p?"undefined":_typeof(p)))+' Pass in a factory or disable this message with router.warnings("requiresChecking", false)')}),Array.prototype.push.apply(this._requires,_.flatten(arguments)),this},this.require=this.requires,this.matches=function(path,requires){return $q.promise(function(resolve,reject){var segValues;if(!_this._path||_this._path.test(path)&&(segValues=_this.extractParams(path))&&_this._segments.every(function(seg){return _.isFunction(seg.validator)?seg.validator(segValues[seg.id]):seg.validator})){if(!_this._requires.length||!1===requires)return resolve();$q.all(_this._requires.map(function(r){var factoryReturn=r(path,_this);return!0===factoryReturn?$q.resolve():!1===factoryReturn?$q.reject():factoryReturn})).then(function(){return resolve()}).catch(function(){return reject()})}else reject()})},this.path=function(path){_.isRegExp(path)?(this._path=path,this._segments=[]):_.isString(path)&&path&&(this._pathHuman=path,this._path=router.pathToRegExp(path),this._segments=(path.match(/:[a-z0-9_-]+\??/gi)||[]).map(function(seg){var segExamined=/^:(.+?)(\?)?$/.exec(seg);return{id:segExamined[1],required:!segExamined[2],validator:router.tokenRules[segExamined[1]]||!0}}))},this.extractParams=function(path){if(!this._path)return{};var extracted=this._path.exec(path),params={};return this._segments.forEach(function(seg,i){return params[seg.id]=extracted&&extracted[i+1]?extracted[i+1].replace(/^\//,""):null}),params},this.extractQuery=function(query){return query?_(_(query).trimStart("?").split("&")).map(function(pair){var keyVal=pair.split("=",2);return keyVal.length<2?[keyVal[0],!0]:keyVal}).fromPairs().mapKeys(function(v,k){return decodeURIComponent(k)}).mapValues(function(v,k){return decodeURIComponent(v)}).value():{}},this.path(path),router.routes.push(this),router.sort.isSorted=!1,this};return router.pathToRegExp=function(path){var safePath=path.replace(/\/:[a-z0-9_-]+(\?)?/gi,function(all,optional){return"!!!CAPTURE "+(optional?"OPTIONAL":"REQUIRED")+"!!!"}).replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\"+String.fromCharCode(36)+"&").replace(/!!!CAPTURE OPTIONAL!!!/g,"(\\/[^/]+)?").replace(/!!!CAPTURE REQUIRED!!!/g,"(\\/[^/]+)");return new RegExp("^"+safePath+String.fromCharCode(36))},router.rule=function(path){return new RouterRule(path)},router.when=router.rule,router.resolve=function(path){return router.sort.enabled&&!router.sort.isSorted&&(router.sort.sorter(),router.sort.isSorted=!0),$q.promise(function(mainResolve,mainReject){router.routes.reduce(function(chain,rule){return chain.then(function(){return $q.promise(function(ruleResolve,ruleReject){rule.matches(path).then(function(){return mainResolve(rule)}).catch(function(err){err?mainReject(err):ruleResolve()})})})},$q.resolve()).then(function(){return mainReject("Nothing matches")})})},router.go=function(rawPath,params){return rawPath||(rawPath="/"),$q.promise(function(resolve,reject){var urlInfo=/^(.*?)(\?.*)?$/.exec(rawPath),path=urlInfo[1],query=urlInfo[2];router.resolve(path).then(function(rule){router.current;switch(router.path=path,router.current=rule,_.forEach(router.params,function(v,k){return delete router.params[k]}),_.isObject(params)&&_.assign(router.params,params),_.assign(router.params,rule.extractParams(path)),_.assign(router.params,_.mapValues(rule._params,function(v,k){return _.isFunction(v)?v():v})),_.forEach(function(v,k){return delete router.query[k]}),_.assign(router.query,rule.extractQuery(query)),resolve(rule),router.current._action){case"views":break;case"redirect":router.redirect(router.current._redirect);break;default:throw new Error("Unknown router action: "+router.current._action)}}).catch(function(err){reject(err)})})},router.warnings=function(key,val){if(_.isBoolean(key))_.forEach(router.warns,function(v,k){return router.warns[k]=val});else{if(!router.warns[key])throw new Error("Unknown warning key to disable: "+key+". Valid warning keys are: "+_.keys(router.warns));router.warns[key]=val}return router},router.tokenRule=function(token,validator){return router.tokenRules[_.trimStart(token,":")]=validator,router},router.setQuery=function(key,val){var newQuery;return void 0===val||_.isEmpty(key)?delete(newQuery=key?_.clone(router.query):{})[key]:_.isObject(key)?newQuery=key:(newQuery=key?_.clone(router.query):{})[key]=val,router.setHash("#"+router.path+(_.isEmpty(newQuery)?"":"?"+_.map(newQuery,function(v,k){return k+"="+v}).join("&"))),router},router};